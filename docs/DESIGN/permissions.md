# 运行时权限请求（Cursor 式）设计

> 目标：类似 Cursor，在执行敏感操作前主动询问用户，支持「访问某路径」「安装依赖」「执行命令」等动态场景。
> 区别于静态 `confirmRequired`（工具级），这里是**请求级**的运行时确认。

## 与现有机制的关系

| 机制 | 粒度 | 时机 | 示例 |
|------|------|------|------|
| **confirmRequired** | 工具级（静态） | 执行前 | `write_file`、`run_command` 等高危工具一律确认 |
| **运行时权限请求** | 请求级（动态） | 执行前 | 某次请求需要额外授权（如访问超出允许范围的路径、首次安装依赖） |
| **可操作错误消息** | 失败后补救 | 执行失败后 | Chromium 未安装 → 展示「一键安装」按钮 |

> 现状提示：目前 `read_file/list_files/write_file` 都只允许访问 `tools.fileBase`（默认 `~/.crabcrush`）下的相对路径；“访问超出 fileBase 的路径”属于未来能力，一旦开放就必须配套本设计。

## 触发条件（建议）

工具执行前检测到需额外授权时触发，例如：

- 访问路径超出默认允许范围（未来若支持）
- 首次安装依赖（如 Playwright Chromium）
- 执行外部命令（未来的 `run_command` / 代码执行沙箱等）

## 协议草案（建议）

工具层不直接执行，返回结构化对象并暂停：

```ts
{
  type: 'permission_request',
  action: string,
  message: string,
  params?: object
}
```

## 用户响应（建议）

- **WebChat**：弹窗/按钮「允许」「拒绝」
- **钉钉/飞书/企微**：交互卡片（能点则点，不能点则降级为文本）

授权范围建议支持：

- **仅本次**
- **加入白名单**（可选：如把某路径加入允许列表，或临时 allowlist）

## 渠道兼容（建议）

与「可操作错误消息」复用一套交互能力：

- 有按钮 → 展示按钮
- 无按钮 / 本地模式无 `publicUrl` → 降级为文本说明 + 用户回复「允许」后继续

## 典型场景（示例）

- 访问新路径（未来能力）：`read_file` 请求 `D:/work/notes.md` → 询问「是否允许访问 `D:\work\`？」
- 安装依赖：`browse_url` 需要 Chromium → 询问「是否允许安装 Chromium？」
- 执行命令（未来能力）：`run_command` 请求执行 `npm install xxx` → 询问「是否允许执行该命令？」

## 实现时机（建议）

在 `confirmRequired`（Phase 2a.2）落地后扩展为统一的权限请求框架；并与 Phase 2a.3 的「可操作错误消息」复用同一套 UI/协议。

