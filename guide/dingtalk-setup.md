# 钉钉机器人接入指南

CrabCrush 支持钉钉 **Stream 模式**，不需要公网 IP，本地启动即可工作。

## 第一步：创建钉钉应用

1. 登录 [钉钉开放平台](https://open-dev.dingtalk.com/)
2. 点击 **应用开发** → **企业内部开发** → **创建应用**
3. 填写应用名称（如"CrabCrush"）、描述等基本信息

## 第二步：开启机器人能力

1. 进入你创建的应用
2. 左侧菜单找到 **应用能力** → **机器人**
3. 填写机器人名称、头像、简介
4. **消息接收模式** 选择 **Stream 模式**（非常重要！）
5. 点击 **发布**

> **为什么选 Stream 模式？**
> Stream 模式由客户端主动与钉钉服务器建立长连接，消息通过这条连接推送过来。
> 相比 HTTP 模式（需要钉钉回调你的服务器），Stream 模式不需要公网 IP、不需要域名、
> 不需要配置反向代理，在本地开发环境即可工作。

## 第三步：获取凭证

1. 左侧菜单点击 **凭证与基础信息**
2. 复制 **AppKey**（= clientId）和 **AppSecret**（= clientSecret）

> 注意：不是"机器人"页面的信息，而是应用级别的"凭证与基础信息"页面。

## 第四步：配置 CrabCrush

在 `crabcrush.yaml` 中添加钉钉配置：

```yaml
channels:
  dingtalk:
    enabled: true
    clientId: 你的AppKey
    clientSecret: 你的AppSecret
```

也可以用环境变量（适合不想把密钥写进文件的场景）：

```bash
export CRABCRUSH_DINGTALK_CLIENT_ID=你的AppKey
export CRABCRUSH_DINGTALK_CLIENT_SECRET=你的AppSecret
```

> **使用工具（搜索、抓网页）？** 若配置了 `ownerIds`，需把钉钉用户的 `senderStaffId` 加进去；不配置时默认所有人都是 owner。控制台日志会打印收到的 `senderStaffId`。

> 使用环境变量时不需要在 yaml 里写 `clientId` / `clientSecret`，
> 只要环境变量存在，钉钉渠道会自动启用。

## 第五步：启动服务

```bash
pnpm dev
```

看到以下日志说明连接成功：

```
🦀 CrabCrush Gateway 已启动
   渠道: 钉钉 Stream
钉钉 Stream 已连接
```

如果看到报错，参考下方 [常见问题](#常见问题)。

## 第六步：在钉钉群里使用

两种方式找到你的机器人：

**方式一：在钉钉"功能"中搜索**
1. 打开钉钉，在顶部搜索栏搜索你的机器人名字
2. 切换到 **功能** 标签页，即可找到你的机器人

**方式二：在群里手动添加**
1. 打开一个**企业内部群**（或创建一个测试群）
2. 点击右上角**群设置**（齿轮图标）
3. 找到 **机器人** → **添加机器人**
4. 在列表中找到你的机器人，点击添加

添加后，在群里发送 **@你的机器人名字 你好**

机器人会在几秒内回复。如果消息包含代码或格式化内容，会自动使用 Markdown 格式。

## 注意事项

- **必须 @** — 在群里必须用 `@机器人名字` 才能触发，直接发消息机器人收不到
- **企业内部群** — 机器人只能添加到企业内部群，外部群和个人聊天无法添加
- **同一组织** — 你的钉钉账号必须和创建应用的企业属于同一组织
- **应用已发布** — 如果在添加机器人列表中找不到，确认应用已经点击"发布"
- **Stream 模式** — 确认消息接收模式选的是 Stream，不是 HTTP

## 常见问题

### Q: 启动时报 `Request failed with status code 400`

可能原因：
- `clientId` 或 `clientSecret` 填错了，检查是否多了空格
- 应用还没有发布，去开放平台点击"发布"
- 机器人能力没有开启，检查"应用能力 → 机器人"是否已配置
- 消息接收模式不是 Stream 模式

### Q: 添加机器人时列表里找不到

- 确认应用已发布（状态显示"已发布"）
- 确认群是企业内部群（不是外部群）
- 确认你的账号和应用在同一个企业/组织下

### Q: @机器人后没有回复

- 检查 CrabCrush 终端日志，看是否收到了消息
- 确认模型 API Key 配置正确（机器人收到消息但模型调用失败时，终端会有报错）
- 确认 CrabCrush 服务还在运行（没有崩溃退出）

### Q: 回复很慢

- 首次回复需要等模型响应，通常 1-3 秒
- 钉钉 Stream 模式本身有少量延迟（< 1 秒）
- 如果超过 10 秒无回复，检查终端日志是否有超时报错
