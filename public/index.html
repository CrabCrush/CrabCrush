<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrabCrush - AI åŠ©æ‰‹</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --primary: #e94560;
      --primary-dim: #c13550;
      --text: #e8e8e8;
      --text-muted: #777;
      --user-bg: #0f3460;
      --bot-bg: #1e1e36;
      --border: #2a2a40;
      --code-bg: #161b22;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC',
        'Microsoft YaHei', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      padding: 0.7rem 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    .subtitle { font-size: 0.72rem; color: var(--text-muted); }

    /* Status bar */
    #status {
      text-align: center;
      padding: 0.3rem;
      font-size: 0.72rem;
      color: var(--text-muted);
      background: var(--surface);
      flex-shrink: 0;
    }
    #status.connected { color: #4ade80; }
    #status.error { color: #f87171; }

    /* Messages area */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Message bubbles */
    .message {
      max-width: 85%;
      margin-bottom: 0.75rem;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      line-height: 1.7;
      word-break: break-word;
      font-size: 0.95rem;
      animation: fadeIn 0.15s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } }
    .message.user {
      background: var(--user-bg);
      margin-left: auto;
      border-bottom-right-radius: 4px;
      white-space: pre-wrap;
    }
    .message.assistant {
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
    }
    .message.error {
      background: #2d1b1b;
      color: #f87171;
      border: 1px solid #4a2020;
      white-space: pre-wrap;
    }

    /* Streaming cursor */
    .streaming-cursor {
      display: inline-block;
      width: 2px; height: 1.1em;
      background: var(--primary);
      margin-left: 2px;
      vertical-align: text-bottom;
      animation: blink 0.7s infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Markdown content inside bot messages */
    .message.assistant p { margin: 0.4em 0; }
    .message.assistant p:first-child { margin-top: 0; }
    .message.assistant p:last-child { margin-bottom: 0; }
    .message.assistant ul, .message.assistant ol {
      margin: 0.4em 0;
      padding-left: 1.5em;
    }
    .message.assistant li { margin: 0.15em 0; }
    .message.assistant blockquote {
      border-left: 3px solid var(--primary);
      padding-left: 0.8em;
      margin: 0.5em 0;
      color: var(--text-muted);
    }
    .message.assistant h1, .message.assistant h2,
    .message.assistant h3, .message.assistant h4 {
      margin: 0.6em 0 0.3em;
      line-height: 1.3;
    }
    .message.assistant h1 { font-size: 1.3em; }
    .message.assistant h2 { font-size: 1.15em; }
    .message.assistant h3 { font-size: 1.05em; }
    .message.assistant hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.8em 0;
    }
    .message.assistant a {
      color: #60a5fa;
      text-decoration: none;
    }
    .message.assistant a:hover { text-decoration: underline; }
    .message.assistant strong { color: #fff; }
    .message.assistant table {
      border-collapse: collapse;
      margin: 0.5em 0;
      font-size: 0.9em;
    }
    .message.assistant th, .message.assistant td {
      border: 1px solid var(--border);
      padding: 0.35em 0.7em;
    }
    .message.assistant th {
      background: var(--surface);
      font-weight: 600;
    }

    /* Inline code */
    .message.assistant code {
      background: var(--code-bg);
      padding: 0.15em 0.4em;
      border-radius: 4px;
      font-size: 0.88em;
      font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
    }

    /* Code blocks */
    .message.assistant pre {
      background: var(--code-bg);
      border-radius: 8px;
      margin: 0.5em 0;
      overflow-x: auto;
      position: relative;
    }
    .message.assistant pre code {
      display: block;
      padding: 0.8em 1em;
      background: transparent;
      font-size: 0.85em;
      line-height: 1.5;
    }
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3em 0.8em;
      background: #1c2333;
      border-radius: 8px 8px 0 0;
      font-size: 0.75em;
      color: var(--text-muted);
    }
    .copy-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 0.15em 0.5em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .copy-btn:hover { color: var(--text); border-color: var(--text-muted); }
    .copy-btn.copied { color: #4ade80; border-color: #4ade80; }

    /* Token usage */
    .usage {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      margin-top: 0.2rem;
      margin-bottom: 0.5rem;
    }

    /* Welcome screen */
    .welcome {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }
    .welcome .emoji { font-size: 3rem; margin-bottom: 0.5rem; }
    .welcome h2 { color: var(--text); margin-bottom: 0.5rem; font-size: 1.2rem; }
    .welcome p { font-size: 0.9rem; line-height: 1.6; }

    /* Input area */
    #input-area {
      padding: 0.75rem 1rem;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
      flex-shrink: 0;
    }
    #input {
      flex: 1;
      padding: 0.65rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 42px;
      max-height: 150px;
      transition: border-color 0.2s;
    }
    #input:focus { border-color: var(--primary); }
    #input::placeholder { color: var(--text-muted); }
    #input:disabled { opacity: 0.5; }
    .action-btn {
      padding: 0.65rem 1.2rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-family: inherit;
      transition: background 0.2s, opacity 0.2s;
      white-space: nowrap;
    }
    #send {
      background: var(--primary);
    }
    #send:hover { background: var(--primary-dim); }
    #send:disabled { opacity: 0.4; cursor: not-allowed; }
    #stop-btn {
      background: #dc2626;
      display: none;
    }
    #stop-btn:hover { background: #b91c1c; }

    @media (max-width: 600px) {
      .message { max-width: 92%; font-size: 0.9rem; }
      #input-area { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <span style="font-size:1.3rem">ğŸ¦€</span>
    <div>
      <h1>CrabCrush</h1>
      <div class="subtitle">ä½ çš„ç§äºº AI åŠ©æ‰‹</div>
    </div>
  </header>
  <div id="status">è¿æ¥ä¸­...</div>
  <div id="messages">
    <div class="welcome">
      <div class="emoji">ğŸ¦€</div>
      <h2>ä½ å¥½ï¼æˆ‘æ˜¯ CrabCrush</h2>
      <p>åšä½ çš„è™¾å…µèŸ¹å°† â€”â€” éšæ—¶ä¸ºä½ æœåŠ¡<br>è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p>
    </div>
  </div>
  <div id="input-area">
    <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€, Shift+Enter æ¢è¡Œ)" rows="1"></textarea>
    <button id="send" class="action-btn" disabled>å‘é€</button>
    <button id="stop-btn" class="action-btn">åœæ­¢</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
  <script>
    // â”€â”€ Markdown æ¸²æŸ“å™¨ â”€â”€
    const md = window.markdownit({
      html: false,
      linkify: true,
      typographer: true,
      highlight(str, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try { return hljs.highlight(str, { language: lang }).value; } catch {}
        }
        try { return hljs.highlightAuto(str).value; } catch {}
        return '';
      },
    });

    // è‡ªå®šä¹‰ fence æ¸²æŸ“ï¼šæ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶æŒ‰é’®
    const defaultFence = md.renderer.rules.fence;
    md.renderer.rules.fence = function(tokens, idx, options, env, self) {
      const token = tokens[idx];
      const lang = token.info.trim() || 'text';
      const code = token.content;
      const highlighted = options.highlight(code, lang) || md.utils.escapeHtml(code);
      return `<div class="code-header"><span>${lang}</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div><pre><code class="hljs language-${lang}">${highlighted}</code></pre>`;
    };

    // â”€â”€ DOM å…ƒç´  â”€â”€
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const stopBtn = document.getElementById('stop-btn');
    const statusEl = document.getElementById('status');

    let ws;
    let currentBotMsg = null;
    let rawContent = '';          // å½“å‰ bot æ¶ˆæ¯çš„åŸå§‹æ–‡æœ¬
    let isStreaming = false;
    let sessionId = localStorage.getItem('crabcrush_session') || null;
    let welcomeShown = true;
    let renderRAF = null;         // requestAnimationFrame IDï¼Œç”¨äºèŠ‚æµæ¸²æŸ“

    // â”€â”€ WebSocket è¿æ¥ â”€â”€
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      // ä¼ é€’ URL ä¸­çš„ token å‚æ•°åˆ° WebSocket è¿æ¥
      const urlParams = new URLSearchParams(location.search);
      const token = urlParams.get('token');
      const wsUrl = token
        ? `${protocol}//${location.host}/ws?token=${encodeURIComponent(token)}`
        : `${protocol}//${location.host}/ws`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        statusEl.textContent = 'å·²è¿æ¥';
        statusEl.className = 'connected';
        if (!isStreaming) sendBtn.disabled = false;

        // å¦‚æœæœ‰å·²ä¿å­˜çš„ sessionIdï¼Œè¯·æ±‚åŠ è½½å†å²æ¶ˆæ¯
        if (sessionId) {
          ws.send(JSON.stringify({ type: 'loadHistory', sessionId }));
        }
      };

      ws.onclose = () => {
        statusEl.textContent = 'è¿æ¥æ–­å¼€ï¼Œ3ç§’åé‡è¿...';
        statusEl.className = 'error';
        sendBtn.disabled = true;
        setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        statusEl.textContent = 'è¿æ¥å‡ºé”™';
        statusEl.className = 'error';
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === 'session') {
          sessionId = msg.sessionId;
          localStorage.setItem('crabcrush_session', sessionId);

        } else if (msg.type === 'history') {
          // æœåŠ¡å™¨è¿”å›å†å²æ¶ˆæ¯ï¼Œæ¸²æŸ“åˆ°èŠå¤©åŒºåŸŸ
          if (msg.messages && msg.messages.length > 0) {
            // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
            if (welcomeShown) {
              messagesEl.innerHTML = '';
              welcomeShown = false;
            }
            for (const m of msg.messages) {
              const el = addMessage(m.role, '');
              const contentEl = el.querySelector('.msg-content');
              if (contentEl) {
                contentEl.innerHTML = renderMarkdown(m.content);
                // ç»™ä»£ç å—åŠ å¤åˆ¶æŒ‰é’®
                contentEl.querySelectorAll('pre code').forEach(addCopyButton);
              }
            }
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }

        } else if (msg.type === 'chunk') {
          if (!currentBotMsg) {
            currentBotMsg = addMessage('assistant', '');
          }
          rawContent += msg.content;
          scheduleRender();

        } else if (msg.type === 'done') {
          // æœ€ç»ˆæ¸²æŸ“ï¼ˆç¡®ä¿å®Œæ•´å†…å®¹æ­£ç¡®æ˜¾ç¤ºï¼‰
          if (currentBotMsg) {
            cancelAnimationFrame(renderRAF);
            renderMarkdown(currentBotMsg, rawContent);
          }
          if (msg.usage || msg.model || msg.cost) {
            showUsage(msg.usage, msg.model, msg.cost);
          }
          finishStreaming();

        } else if (msg.type === 'error') {
          if (currentBotMsg) {
            cancelAnimationFrame(renderRAF);
            renderMarkdown(currentBotMsg, rawContent);
          }
          addMessage('error', `${msg.message}`);
          finishStreaming();
        }
      };
    }

    // â”€â”€ æ¶ˆæ¯æ¸²æŸ“ â”€â”€
    function addMessage(role, content) {
      if (welcomeShown) {
        const w = messagesEl.querySelector('.welcome');
        if (w) w.remove();
        welcomeShown = false;
      }
      const el = document.createElement('div');
      el.className = `message ${role}`;
      if (role === 'user' || role === 'error') {
        el.textContent = content;
      }
      messagesEl.appendChild(el);
      scrollToBottom();
      return el;
    }

    /** èŠ‚æµæ¸²æŸ“ï¼šæ¯ä¸ª animation frame æœ€å¤šæ¸²æŸ“ä¸€æ¬¡ */
    function scheduleRender() {
      if (renderRAF) return;
      renderRAF = requestAnimationFrame(() => {
        renderRAF = null;
        if (currentBotMsg) {
          renderMarkdown(currentBotMsg, rawContent, true);
          scrollToBottom();
        }
      });
    }

    /** æ¸²æŸ“ Markdown åˆ°å…ƒç´  */
    function renderMarkdown(el, text, showCursor) {
      el.innerHTML = md.render(text);
      if (showCursor) {
        const cursor = document.createElement('span');
        cursor.className = 'streaming-cursor';
        el.appendChild(cursor);
      }
    }

    function showUsage(usage, model, cost) {
      const parts = [];
      if (model) parts.push(model);
      if (usage) {
        const prompt = usage.promptTokens ?? '?';
        const completion = usage.completionTokens ?? '?';
        parts.push(`tokens: ${prompt} â†’ ${completion}`);
      }
      if (cost) parts.push(cost);
      if (parts.length === 0) return;

      const el = document.createElement('div');
      el.className = 'usage';
      el.textContent = parts.join(' | ');
      messagesEl.appendChild(el);
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // â”€â”€ å‘é€ / åœæ­¢ â”€â”€
    function send() {
      const content = inputEl.value.trim();
      if (!content || isStreaming || !ws || ws.readyState !== 1) return;

      addMessage('user', content);

      const payload = { type: 'chat', content };
      if (sessionId) payload.sessionId = sessionId;
      ws.send(JSON.stringify(payload));

      inputEl.value = '';
      inputEl.style.height = 'auto';
      startStreaming();
    }

    function stopGeneration() {
      if (!isStreaming || !ws || ws.readyState !== 1) return;
      ws.send(JSON.stringify({ type: 'stop' }));
    }

    function startStreaming() {
      isStreaming = true;
      rawContent = '';
      currentBotMsg = null;
      sendBtn.style.display = 'none';
      stopBtn.style.display = '';
      inputEl.disabled = true;
    }

    function finishStreaming() {
      isStreaming = false;
      rawContent = '';
      currentBotMsg = null;
      sendBtn.style.display = '';
      stopBtn.style.display = 'none';
      sendBtn.disabled = false;
      inputEl.disabled = false;
      inputEl.focus();
    }

    // â”€â”€ å¤åˆ¶ä»£ç  â”€â”€
    function copyCode(btn) {
      const pre = btn.closest('.code-header').nextElementSibling;
      const code = pre?.querySelector('code')?.textContent || '';
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'å·²å¤åˆ¶';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'å¤åˆ¶';
          btn.classList.remove('copied');
        }, 2000);
      });
    }
    window.copyCode = copyCode;

    // â”€â”€ äº‹ä»¶ç»‘å®š â”€â”€
    sendBtn.addEventListener('click', send);
    stopBtn.addEventListener('click', stopGeneration);

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
    });

    connect();
  </script>
</body>
</html>
