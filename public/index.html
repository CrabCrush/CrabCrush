<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrabCrush - AI åŠ©æ‰‹</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-hover: #222240;
      --primary: #e94560;
      --primary-dim: #c13550;
      --text: #e8e8e8;
      --text-muted: #777;
      --user-bg: #0f3460;
      --bot-bg: #1e1e36;
      --border: #2a2a40;
      --radius: 12px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 0.8rem 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    header .logo { font-size: 1.3rem; }
    header .subtitle { font-size: 0.75rem; color: var(--text-muted); }
    #status {
      text-align: center;
      padding: 0.35rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--surface);
    }
    #status.connected { color: #4ade80; }
    #status.error { color: #f87171; }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .message {
      max-width: 85%;
      margin-bottom: 0.75rem;
      padding: 0.7rem 1rem;
      border-radius: var(--radius);
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.95rem;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    .message.user {
      background: var(--user-bg);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
    }
    .message.assistant .cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--primary);
      margin-left: 2px;
      vertical-align: text-bottom;
      animation: blink 0.8s infinite;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .message.error {
      background: #2d1b1b;
      color: #f87171;
      border: 1px solid #4a2020;
    }
    .usage {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      margin-top: 0.3rem;
      margin-bottom: 0.5rem;
    }
    .welcome {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }
    .welcome .emoji { font-size: 3rem; margin-bottom: 0.5rem; }
    .welcome h2 { color: var(--text); margin-bottom: 0.5rem; font-size: 1.2rem; }
    .welcome p { font-size: 0.9rem; line-height: 1.6; }
    #input-area {
      padding: 0.75rem 1rem;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }
    #input {
      flex: 1;
      padding: 0.65rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 42px;
      max-height: 150px;
      transition: border-color 0.2s;
    }
    #input:focus { border-color: var(--primary); }
    #input::placeholder { color: var(--text-muted); }
    #send {
      padding: 0.65rem 1.2rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-family: inherit;
      transition: background 0.2s;
      white-space: nowrap;
    }
    #send:hover { background: var(--primary-dim); }
    #send:disabled { opacity: 0.4; cursor: not-allowed; }
    @media (max-width: 600px) {
      .message { max-width: 92%; }
      #input-area { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <span class="logo">ğŸ¦€</span>
    <div>
      <h1>CrabCrush</h1>
      <div class="subtitle">ä½ çš„ç§äºº AI åŠ©æ‰‹</div>
    </div>
  </header>
  <div id="status">è¿æ¥ä¸­...</div>
  <div id="messages">
    <div class="welcome">
      <div class="emoji">ğŸ¦€</div>
      <h2>ä½ å¥½ï¼æˆ‘æ˜¯ CrabCrush</h2>
      <p>åšä½ çš„è™¾å…µèŸ¹å°† â€”â€” éšæ—¶ä¸ºä½ æœåŠ¡<br>è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p>
    </div>
  </div>
  <div id="input-area">
    <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€, Shift+Enter æ¢è¡Œ)" rows="1"></textarea>
    <button id="send" disabled>å‘é€</button>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');

    let ws;
    let currentBotMsg = null;
    let isStreaming = false;
    let sessionId = localStorage.getItem('crabcrush_session') || null;
    let welcomeShown = true;

    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        statusEl.textContent = 'å·²è¿æ¥';
        statusEl.className = 'connected';
        sendBtn.disabled = false;
      };

      ws.onclose = () => {
        statusEl.textContent = 'è¿æ¥æ–­å¼€ï¼Œ3 ç§’åé‡è¿...';
        statusEl.className = 'error';
        sendBtn.disabled = true;
        isStreaming = false;
        setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        statusEl.textContent = 'è¿æ¥é”™è¯¯';
        statusEl.className = 'error';
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === 'session') {
          sessionId = msg.sessionId;
          localStorage.setItem('crabcrush_session', sessionId);
        } else if (msg.type === 'chunk') {
          if (!currentBotMsg) {
            currentBotMsg = addMessage('assistant', '');
          }
          // ç§»é™¤æ—§å…‰æ ‡ï¼Œè¿½åŠ å†…å®¹ï¼Œæ·»åŠ æ–°å…‰æ ‡
          removeCursor(currentBotMsg);
          currentBotMsg.insertAdjacentText('beforeend', msg.content);
          addCursor(currentBotMsg);
          scrollToBottom();
        } else if (msg.type === 'done') {
          if (currentBotMsg) removeCursor(currentBotMsg);
          if (msg.usage) {
            showUsage(msg.usage);
          }
          currentBotMsg = null;
          isStreaming = false;
          sendBtn.disabled = false;
          inputEl.disabled = false;
          inputEl.focus();
        } else if (msg.type === 'error') {
          if (currentBotMsg) removeCursor(currentBotMsg);
          addMessage('error', `âŒ ${msg.message}`);
          currentBotMsg = null;
          isStreaming = false;
          sendBtn.disabled = false;
          inputEl.disabled = false;
          inputEl.focus();
        }
      };
    }

    function addMessage(role, content) {
      // é¦–æ¡æ¶ˆæ¯æ—¶æ¸…é™¤æ¬¢è¿è¯­
      if (welcomeShown) {
        const welcome = messagesEl.querySelector('.welcome');
        if (welcome) welcome.remove();
        welcomeShown = false;
      }

      const el = document.createElement('div');
      el.className = `message ${role}`;
      el.textContent = content;
      messagesEl.appendChild(el);
      scrollToBottom();
      return el;
    }

    function addCursor(el) {
      const cursor = document.createElement('span');
      cursor.className = 'cursor';
      el.appendChild(cursor);
    }

    function removeCursor(el) {
      const cursor = el.querySelector('.cursor');
      if (cursor) cursor.remove();
    }

    function showUsage(usage) {
      const el = document.createElement('div');
      el.className = 'usage';
      el.textContent = `tokens: ${usage.promptTokens ?? '?'} â†’ ${usage.completionTokens ?? '?'}`;
      messagesEl.appendChild(el);
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function send() {
      const content = inputEl.value.trim();
      if (!content || isStreaming || !ws || ws.readyState !== 1) return;

      addMessage('user', content);

      const payload = { type: 'chat', content };
      if (sessionId) payload.sessionId = sessionId;
      ws.send(JSON.stringify(payload));

      inputEl.value = '';
      inputEl.style.height = 'auto';
      isStreaming = true;
      sendBtn.disabled = true;
      inputEl.disabled = true;
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // è‡ªåŠ¨è°ƒæ•´ textarea é«˜åº¦
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
    });

    connect();
  </script>
</body>
</html>
