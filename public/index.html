<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrabCrush - AI åŠ©æ‰‹</title>
  <!-- æœ¬åœ° vendor ä¼˜å…ˆï¼Œé¿å… CDN è¶…æ—¶ï¼›æ—  token æ—¶ä¹Ÿå¯åŠ è½½ -->
  <link rel="stylesheet" href="/vendor/github-dark.min.css" onerror="this.onerror=null;this.href='https://unpkg.npmmirror.com/highlight.js@11.11.1/styles/github-dark.min.css'">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --primary: #e94560;
      --primary-dim: #c13550;
      --text: #e8e8e8;
      --text-muted: #777;
      --user-bg: #0f3460;
      --bot-bg: #1e1e36;
      --border: #2a2a40;
      --code-bg: #161b22;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC',
        'Microsoft YaHei', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      padding: 0.7rem 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      flex-shrink: 0;
      position: relative;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    .subtitle { font-size: 0.72rem; color: var(--text-muted); }
    #sessions-btn {
      position: absolute;
      left: 1rem;
      padding: 0.35rem 0.7rem;
      font-size: 0.85rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
    }
    #sessions-btn:hover { color: var(--text); border-color: var(--text-muted); }
    /* ä¼šè¯ä¾§è¾¹æ  */
    #sessions-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 260px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
    }
    #sessions-sidebar.open { transform: translateX(0); }
    #sessions-sidebar-header {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #sessions-sidebar-header h3 { font-size: 0.95rem; }
    #sessions-new { font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--border); border: none; border-radius: 4px; color: var(--text); cursor: pointer; }
    #sessions-new:hover { background: var(--text-muted); color: white; }
    #sessions-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
    #sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .session-item {
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.25rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .session-item:hover { background: var(--border); }
    .session-item.active { background: var(--user-bg); color: white; }
    .session-item .meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }
    #sessions-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    #sessions-overlay.visible { opacity: 1; pointer-events: auto; }

    /* Status bar */
    #status {
      text-align: center;
      padding: 0.3rem;
      font-size: 0.72rem;
      color: var(--text-muted);
      background: var(--surface);
      flex-shrink: 0;
    }
    #status.connected { color: #4ade80; }
    #status.error { color: #f87171; }

    /* Messages area */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Message bubbles */
    .message {
      max-width: 85%;
      margin-bottom: 0.75rem;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      line-height: 1.7;
      word-break: break-word;
      font-size: 0.95rem;
      animation: fadeIn 0.15s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } }
    .message.user {
      background: var(--user-bg);
      margin-left: auto;
      border-bottom-right-radius: 4px;
      white-space: pre-wrap;
    }
    .message.assistant {
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
    }
    .message.error {
      background: #2d1b1b;
      color: #f87171;
      border: 1px solid #4a2020;
      white-space: pre-wrap;
    }

    .messages-load-more {
      position: sticky;
      top: 0;
      z-index: 2;
      text-align: center;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      background: var(--bg);
    }
    .messages-load-more button {
      font-size: 0.85rem;
      padding: 0.3rem 0.8rem;
      background: var(--border);
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .messages-load-more button:hover:not(:disabled) { background: var(--text-muted); color: white; }
    .messages-load-more button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Streaming cursor */
    .streaming-cursor {
      display: inline-block;
      width: 2px; height: 1.1em;
      background: var(--primary);
      margin-left: 2px;
      vertical-align: text-bottom;
      animation: blink 0.7s infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Markdown content inside bot messages */
    .message.assistant p { margin: 0.4em 0; }
    .message.assistant p:first-child { margin-top: 0; }
    .message.assistant p:last-child { margin-bottom: 0; }
    .message.assistant ul, .message.assistant ol {
      margin: 0.4em 0;
      padding-left: 1.5em;
    }
    .message.assistant li { margin: 0.15em 0; }
    .message.assistant blockquote {
      border-left: 3px solid var(--primary);
      padding-left: 0.8em;
      margin: 0.5em 0;
      color: var(--text-muted);
    }
    .message.assistant h1, .message.assistant h2,
    .message.assistant h3, .message.assistant h4 {
      margin: 0.6em 0 0.3em;
      line-height: 1.3;
    }
    .message.assistant h1 { font-size: 1.3em; }
    .message.assistant h2 { font-size: 1.15em; }
    .message.assistant h3 { font-size: 1.05em; }
    .message.assistant hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.8em 0;
    }
    .message.assistant a {
      color: #60a5fa;
      text-decoration: none;
    }
    .message.assistant a:hover { text-decoration: underline; }
    .message.assistant strong { color: #fff; }
    .message.assistant table {
      border-collapse: collapse;
      margin: 0.5em 0;
      font-size: 0.9em;
    }
    .message.assistant th, .message.assistant td {
      border: 1px solid var(--border);
      padding: 0.35em 0.7em;
    }
    .message.assistant th {
      background: var(--surface);
      font-weight: 600;
    }

    /* Inline code */
    .message.assistant code {
      background: var(--code-bg);
      padding: 0.15em 0.4em;
      border-radius: 4px;
      font-size: 0.88em;
      font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
    }

    /* Code blocks */
    .message.assistant pre {
      background: var(--code-bg);
      border-radius: 8px;
      margin: 0.5em 0;
      overflow-x: auto;
      position: relative;
    }
    .message.assistant pre code {
      display: block;
      padding: 0.8em 1em;
      background: transparent;
      font-size: 0.85em;
      line-height: 1.5;
    }
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3em 0.8em;
      background: #1c2333;
      border-radius: 8px 8px 0 0;
      font-size: 0.75em;
      color: var(--text-muted);
    }
    .copy-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 0.15em 0.5em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .copy-btn:hover { color: var(--text); border-color: var(--text-muted); }
    .copy-btn.copied { color: #4ade80; border-color: #4ade80; }

    /* Token usage */
    .usage {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      margin-top: 0.2rem;
      margin-bottom: 0.5rem;
    }

    /* Tool call display */
    .tool-call {
      margin: 0.5rem 1rem;
      padding: 0.6rem 0.8rem;
      background: rgba(99, 102, 241, 0.1);
      border-left: 3px solid #6366f1;
      border-radius: 0 6px 6px 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .tool-header { color: var(--text); margin-bottom: 0.3rem; }
    .tool-header strong { color: #818cf8; }
    .tool-args { margin-bottom: 0.2rem; }
    .tool-args code { background: rgba(255,255,255,0.06); padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.85em; }
    .tool-result { color: #a5b4fc; }

    /* Welcome screen */
    .welcome {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }
    .welcome .emoji { font-size: 3rem; margin-bottom: 0.5rem; }
    .welcome h2 { color: var(--text); margin-bottom: 0.5rem; font-size: 1.2rem; }
    .welcome p { font-size: 0.9rem; line-height: 1.6; }

    /* Input area */
    #input-area {
      padding: 0.75rem 1rem;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
      flex-shrink: 0;
    }
    #input {
      flex: 1;
      padding: 0.65rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 42px;
      max-height: 150px;
      transition: border-color 0.2s;
    }
    #input:focus { border-color: var(--primary); }
    #input::placeholder { color: var(--text-muted); }
    #input:disabled { opacity: 0.5; }
    .action-btn {
      padding: 0.65rem 1.2rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-family: inherit;
      transition: background 0.2s, opacity 0.2s;
      white-space: nowrap;
    }
    #send {
      background: var(--primary);
    }
    #send:hover { background: var(--primary-dim); }
    #send:disabled { opacity: 0.4; cursor: not-allowed; }
    #stop-btn {
      background: #dc2626;
      min-width: 4rem;
    }
    #stop-btn:hover:not(.inactive) { background: #b91c1c; }
    #stop-btn.inactive { opacity: 0.4; cursor: default; }
    #input-area.streaming #stop-btn:not(.inactive) {
      animation: stop-pulse 1.5s ease-in-out infinite;
    }
    @keyframes stop-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.4); } 50% { box-shadow: 0 0 0 6px rgba(220,38,38,0); } }

    @media (max-width: 600px) {
      .message { max-width: 92%; font-size: 0.9rem; }
      #input-area { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <div id="sessions-overlay"></div>
  <div id="sessions-sidebar">
    <div id="sessions-sidebar-header">
      <h3>ä¼šè¯åˆ—è¡¨</h3>
      <div style="display:flex;gap:0.3rem;align-items:center">
        <button id="sessions-new" type="button" title="æ–°å»ºä¼šè¯">æ–°å»º</button>
        <button id="sessions-close" type="button" title="å…³é—­">Ã—</button>
      </div>
    </div>
    <div id="sessions-list"></div>
    <div id="sessions-more" style="padding:0.5rem;text-align:center;display:none">
      <button id="sessions-load-more" type="button" style="font-size:0.85rem;padding:0.3rem 0.6rem;background:var(--border);border:none;border-radius:4px;color:var(--text-muted);cursor:pointer">åŠ è½½æ›´å¤š</button>
    </div>
  </div>
  <header>
    <button id="sessions-btn" type="button" title="ä¼šè¯åˆ—è¡¨">ä¼šè¯</button>
    <span style="font-size:1.3rem">ğŸ¦€</span>
    <div>
      <h1>CrabCrush</h1>
      <div class="subtitle">ä½ çš„ç§äºº AI åŠ©æ‰‹</div>
    </div>
  </header>
  <div id="status">è¿æ¥ä¸­...</div>
  <div id="messages">
    <div class="welcome">
      <div class="emoji">ğŸ¦€</div>
      <h2>ä½ å¥½ï¼æˆ‘æ˜¯ CrabCrush</h2>
      <p>åšä½ çš„è™¾å…µèŸ¹å°† â€”â€” éšæ—¶ä¸ºä½ æœåŠ¡<br>è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p>
    </div>
  </div>
  <div id="input-area" class="">
    <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€, Shift+Enter æ¢è¡Œ, Esc åœæ­¢)" rows="1"></textarea>
    <button id="send" class="action-btn" disabled>å‘é€</button>
    <button id="stop-btn" class="action-btn inactive" title="ç”Ÿæˆæ—¶å¯ç‚¹å‡»ç«‹å³åœæ­¢">åœæ­¢</button>
  </div>

  <!-- æœ¬åœ° /vendor ä¼˜å…ˆï¼ˆä¸ä¾èµ–å¤–ç½‘ CDNï¼‰ï¼›å¤±è´¥æ—¶å›é€€åˆ°å›½å†… npmmirror -->
  <script src="/vendor/markdown-it.min.js"></script>
  <script src="/vendor/highlight.min.js" onerror="this.onerror=null;(function(){var s=document.createElement('script');s.src='https://unpkg.npmmirror.com/highlight.js@11.11.1/build/highlight.min.js';document.body.appendChild(s);})();"></script>
  <script>
    // â”€â”€ Markdown æ¸²æŸ“å™¨ï¼ˆæ—  markdownit æ—¶é¡µé¢ä¼šæŠ¥é”™ï¼Œéœ€ä¿è¯ /vendor/markdown-it.min.js å­˜åœ¨ï¼‰â”€â”€
    if (typeof window.markdownit !== 'function') {
      console.error('markdown-it æœªåŠ è½½ï¼Œè¯·è¿è¡Œ: node scripts/copy-vendor.js');
      throw new Error('markdown-it æœªåŠ è½½');
    }
    const md = window.markdownit({
      html: false,
      linkify: true,
      typographer: true,
      highlight(str, lang) {
        if (typeof hljs !== 'undefined' && hljs.highlight) {
          if (lang && hljs.getLanguage(lang)) {
            try { return hljs.highlight(str, { language: lang }).value; } catch {}
          }
          try { return hljs.highlightAuto(str).value; } catch {}
        }
        return md.utils.escapeHtml(str);
      },
    });

    // è‡ªå®šä¹‰ fence æ¸²æŸ“ï¼šæ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶æŒ‰é’®
    const defaultFence = md.renderer.rules.fence;
    md.renderer.rules.fence = function(tokens, idx, options, env, self) {
      const token = tokens[idx];
      const lang = token.info.trim() || 'text';
      const code = token.content;
      const highlighted = options.highlight(code, lang) || md.utils.escapeHtml(code);
      return `<div class="code-header"><span>${lang}</span><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button></div><pre><code class="hljs language-${lang}">${highlighted}</code></pre>`;
    };

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    const TOOL_PREFIX = '__TOOL_CALL__\n';
    function renderMessagesToFragment(messages) {
      const fragment = document.createDocumentFragment();
      for (const m of messages) {
        try {
          if (m.role === 'user' || m.role === 'error') {
            const el = document.createElement('div');
            el.className = `message ${m.role}`;
            el.textContent = m.content || '';
            fragment.appendChild(el);
          } else if (m.role === 'assistant' && m.content) {
            if (m.content.startsWith(TOOL_PREFIX)) {
              let s = m.content;
              while (s.startsWith(TOOL_PREFIX)) {
                const endIdx = s.indexOf('\n__END__');
                if (endIdx < 0) break;
                try {
                  const t = JSON.parse(s.slice(TOOL_PREFIX.length, endIdx));
                  const toolEl = document.createElement('div');
                  toolEl.className = 'tool-call';
                  const icon = t.success ? 'âœ…' : 'âŒ';
                  const safeResult = escapeHtml(String(t.result || ''));
                  toolEl.innerHTML = `<div class="tool-header">${icon} è°ƒç”¨å·¥å…·: <strong>${escapeHtml(t.name || '')}</strong></div><div class="tool-args">å‚æ•°: <code>${escapeHtml(JSON.stringify(t.args || {}))}</code></div><div class="tool-result" style="white-space:pre-wrap">ç»“æœ: ${safeResult}</div>`;
                  fragment.appendChild(toolEl);
                } catch (_) {}
                s = s.slice(endIdx + 8).replace(/^\s+/, '');
              }
            } else {
              const el = document.createElement('div');
              el.className = 'message assistant';
              el.innerHTML = md.render(m.content);
              fragment.appendChild(el);
            }
          }
        } catch (_err) {}
      }
      return fragment;
    }

    let loadingOlderHistory = false;
    function loadOlderHistory() {
      if (!sessionId || !ws || ws.readyState !== 1 || loadingOlderHistory || !hasMoreHistory) return;
      loadingOlderHistory = true;
      const btn = document.querySelector('#messages-load-more button');
      if (btn) { btn.disabled = true; btn.textContent = 'åŠ è½½ä¸­...'; }
      ws.send(JSON.stringify({ type: 'loadHistory', sessionId, limit: HISTORY_PAGE_SIZE, offset: historyOffset }));
    }

    let sessionsListOffset = 0;
    let historyOffset = 0;
    let hasMoreHistory = false;
    const HISTORY_PAGE_SIZE = 100;

    function openSessionsSidebar() {
      document.getElementById('sessions-sidebar').classList.add('open');
      document.getElementById('sessions-overlay').classList.add('visible');
      sessionsListOffset = 0;
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'listConversations', offset: 0 }));
    }

    function closeSessionsSidebar() {
      document.getElementById('sessions-sidebar').classList.remove('open');
      document.getElementById('sessions-overlay').classList.remove('visible');
    }

    function switchSession(id) {
      if (id === sessionId) { closeSessionsSidebar(); return; }
      sessionId = id;
      localStorage.setItem('crabcrush_session', sessionId);
      const url = new URL(location.href);
      url.searchParams.set('session', sessionId);
      history.replaceState(null, '', url.toString());
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'loadHistory', sessionId, limit: 100 }));
      closeSessionsSidebar();
    }

    function newSession() {
      sessionId = null;
      localStorage.removeItem('crabcrush_session');
      const url = new URL(location.href);
      url.searchParams.delete('session');
      history.replaceState(null, '', url.toString());
      messagesEl.innerHTML = '<div class="welcome"><div class="emoji">ğŸ¦€</div><h2>ä½ å¥½ï¼æˆ‘æ˜¯ CrabCrush</h2><p>åšä½ çš„è™¾å…µèŸ¹å°† â€”â€” éšæ—¶ä¸ºä½ æœåŠ¡<br>è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p></div>';
      welcomeShown = true;
      // é€šçŸ¥æœåŠ¡ç«¯é‡ç½® sessionIdï¼Œå¦åˆ™ä¸‹ä¸€æ¡æ¶ˆæ¯ä¼šå‘åˆ°æ—§ä¼šè¯
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'newSession' }));
      closeSessionsSidebar();
    }

    // â”€â”€ DOM å…ƒç´  â”€â”€
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const stopBtn = document.getElementById('stop-btn');
    const statusEl = document.getElementById('status');

    let ws;
    let currentBotMsg = null;
    let rawContent = '';          // å½“å‰ bot æ¶ˆæ¯çš„åŸå§‹æ–‡æœ¬
    let isStreaming = false;
    // sessionId ä¼˜å…ˆä» URL è¯»å–ï¼Œé¿å…å¤š Tab æ—¶ localStorage è¢«å…¶ä»– Tab è¦†ç›–å¯¼è‡´åˆ·æ–°ååŠ è½½é”™è¯¯ä¼šè¯
    const urlParamsInit = new URLSearchParams(location.search);
    let sessionId = urlParamsInit.get('session') || localStorage.getItem('crabcrush_session') || null;
    let welcomeShown = true;
    let renderRAF = null;         // requestAnimationFrame IDï¼Œç”¨äºèŠ‚æµæ¸²æŸ“

    // â”€â”€ WebSocket è¿æ¥ â”€â”€
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      // ä¼ é€’ URL ä¸­çš„ token å‚æ•°åˆ° WebSocket è¿æ¥
      const urlParams = new URLSearchParams(location.search);
      const token = urlParams.get('token');
      const wsUrl = token
        ? `${protocol}//${location.host}/ws?token=${encodeURIComponent(token)}`
        : `${protocol}//${location.host}/ws`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        statusEl.textContent = 'å·²è¿æ¥';
        statusEl.className = 'connected';
        if (!isStreaming) sendBtn.disabled = false;

        // åˆ·æ–°/é‡è¿æ—¶ä¼˜å…ˆä» URL è¯»å– sessionIdï¼Œç¡®ä¿åŠ è½½æ­£ç¡®ä¼šè¯
        const urlParams = new URLSearchParams(location.search);
        const sessionFromUrl = urlParams.get('session');
        if (sessionFromUrl) sessionId = sessionFromUrl;
        if (sessionId) {
          ws.send(JSON.stringify({ type: 'loadHistory', sessionId, limit: 100 }));
        }
      };

      ws.onclose = () => {
        statusEl.textContent = 'è¿æ¥æ–­å¼€ï¼Œ3ç§’åé‡è¿...';
        statusEl.className = 'error';
        if (isStreaming) finishStreaming(); // è¿æ¥æ–­å¼€æ—¶é‡ç½® UI
        sendBtn.disabled = true;
        setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        statusEl.textContent = 'è¿æ¥å‡ºé”™';
        statusEl.className = 'error';
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === 'session') {
          sessionId = msg.sessionId;
          localStorage.setItem('crabcrush_session', sessionId);
          // å†™å…¥ URLï¼Œåˆ·æ–°æ—¶ä¼˜å…ˆä» URL æ¢å¤ï¼Œé¿å…å¤š Tab è¦†ç›–å¯¼è‡´åŠ è½½é”™è¯¯ä¼šè¯
          const url = new URL(location.href);
          url.searchParams.set('session', sessionId);
          history.replaceState(null, '', url.toString());

        } else if (msg.type === 'conversations') {
          const listEl = document.getElementById('sessions-list');
          const moreEl = document.getElementById('sessions-more');
          if (!listEl) return;
          const append = (msg.offset || 0) > 0;
          if (!append) listEl.innerHTML = '';
          if (msg.list && msg.list.length > 0) {
            for (const c of msg.list) {
              const el = document.createElement('div');
              el.className = 'session-item' + (c.id === sessionId ? ' active' : '');
              const title = (c.title || 'ï¼ˆæ— æ ‡é¢˜ï¼‰').slice(0, 40);
              el.innerHTML = `<div>${escapeHtml(title)}</div><div class="meta">${c.messageCount} æ¡æ¶ˆæ¯</div>`;
              el.onclick = () => switchSession(c.id);
              listEl.appendChild(el);
            }
            sessionsListOffset = (msg.offset || 0) + msg.list.length;
          }
          if (!append && (!msg.list || msg.list.length === 0)) {
            listEl.innerHTML = '<div style="padding:1rem;color:var(--text-muted);font-size:0.9rem">æš‚æ— ä¼šè¯</div>';
          }
          if (moreEl) moreEl.style.display = (msg.list && msg.list.length >= 50) ? 'block' : 'none';
        } else if (msg.type === 'history') {
          if (msg.sessionId) {
            sessionId = msg.sessionId;
            localStorage.setItem('crabcrush_session', sessionId);
            const url = new URL(location.href);
            url.searchParams.set('session', sessionId);
            history.replaceState(null, '', url.toString());
          }
          hasMoreHistory = Boolean(msg.hasMore);
          const append = (msg.offset || 0) > 0;
          const fragment = renderMessagesToFragment(msg.messages || []);
          if (!append) {
            messagesEl.innerHTML = '';
            welcomeShown = false;
            if (fragment.childNodes.length > 0) {
              messagesEl.appendChild(fragment);
              historyOffset = msg.messages.length;
            } else {
              messagesEl.innerHTML = '<div class="welcome"><div class="emoji">ğŸ¦€</div><h2>æš‚æ— æ¶ˆæ¯</h2><p>è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯</p></div>';
              welcomeShown = true;
            }
            if (hasMoreHistory) {
              const moreBtn = document.createElement('div');
              moreBtn.id = 'messages-load-more';
              moreBtn.className = 'messages-load-more';
              moreBtn.innerHTML = '<button type="button">åŠ è½½æ›´æ—©çš„æ¶ˆæ¯</button>';
              moreBtn.onclick = loadOlderHistory;
              messagesEl.insertBefore(moreBtn, messagesEl.firstChild);
            }
            messagesEl.scrollTop = messagesEl.scrollHeight;
          } else {
            const loadMoreEl = document.getElementById('messages-load-more');
            const insertBefore = loadMoreEl ? loadMoreEl.nextSibling : messagesEl.firstChild;
            const prevScrollHeight = messagesEl.scrollHeight;
            const prevScrollTop = messagesEl.scrollTop;
            messagesEl.insertBefore(fragment, insertBefore);
            historyOffset += msg.messages.length;
            loadingOlderHistory = false;
            if (!hasMoreHistory && loadMoreEl) loadMoreEl.remove();
            else {
              const btn = loadMoreEl?.querySelector('button');
              if (btn) { btn.disabled = false; btn.textContent = 'åŠ è½½æ›´æ—©çš„æ¶ˆæ¯'; }
            }
            messagesEl.scrollTop = prevScrollTop + (messagesEl.scrollHeight - prevScrollHeight);
          }
        } else if (msg.type === 'tool_call') {
          // å·¥å…·è°ƒç”¨äº‹ä»¶ â€” åœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤ºè°ƒç”¨è¿‡ç¨‹
          const toolEl = document.createElement('div');
          toolEl.className = 'tool-call';
          const statusIcon = msg.success ? 'âœ…' : 'âŒ';
          toolEl.innerHTML = `
            <div class="tool-header">${statusIcon} è°ƒç”¨å·¥å…·: <strong>${escapeHtml(msg.name || '')}</strong></div>
            <div class="tool-args">å‚æ•°: <code>${escapeHtml(JSON.stringify(msg.args || {}))}</code></div>
            <div class="tool-result" style="white-space:pre-wrap">ç»“æœ: ${escapeHtml(String(msg.result || ''))}</div>
          `;
          messagesEl.appendChild(toolEl);
          messagesEl.scrollTop = messagesEl.scrollHeight;

        } else if (msg.type === 'chunk') {
          if (!isStreaming) return; // å¿½ç•¥ stop åè¿Ÿåˆ°çš„ chunkï¼Œé¿å…äº§ç”Ÿå­¤ç«‹æ¶ˆæ¯
          if (!currentBotMsg) {
            currentBotMsg = addMessage('assistant', '');
          }
          rawContent += msg.content;
          scheduleRender();

        } else if (msg.type === 'done') {
          if (!isStreaming) return; // é¿å…é‡å¤å¤„ç†ï¼ˆstop åå¯èƒ½æ”¶åˆ°å¤šå¤„ doneï¼‰
          // æœ€ç»ˆæ¸²æŸ“ï¼ˆç¡®ä¿å®Œæ•´å†…å®¹æ­£ç¡®æ˜¾ç¤ºï¼‰
          if (currentBotMsg) {
            cancelAnimationFrame(renderRAF);
            renderMarkdown(currentBotMsg, rawContent);
          }
          if (msg.usage || msg.model || msg.cost) {
            showUsage(msg.usage, msg.model, msg.cost);
          }
          finishStreaming();

        } else if (msg.type === 'error') {
          if (currentBotMsg) {
            cancelAnimationFrame(renderRAF);
            renderMarkdown(currentBotMsg, rawContent);
          }
          addMessage('error', `${msg.message}`);
          finishStreaming();
        }
      };
    }

    // â”€â”€ æ¶ˆæ¯æ¸²æŸ“ â”€â”€
    function addMessage(role, content) {
      if (welcomeShown) {
        const w = messagesEl.querySelector('.welcome');
        if (w) w.remove();
        welcomeShown = false;
      }
      const el = document.createElement('div');
      el.className = `message ${role}`;
      if (role === 'user' || role === 'error') {
        el.textContent = content;
      }
      messagesEl.appendChild(el);
      scrollToBottom();
      return el;
    }

    /** èŠ‚æµæ¸²æŸ“ï¼šæ¯ä¸ª animation frame æœ€å¤šæ¸²æŸ“ä¸€æ¬¡ */
    function scheduleRender() {
      if (renderRAF) return;
      renderRAF = requestAnimationFrame(() => {
        renderRAF = null;
        if (currentBotMsg) {
          renderMarkdown(currentBotMsg, rawContent, true);
          scrollToBottom();
        }
      });
    }

    /** æ¸²æŸ“ Markdown åˆ°å…ƒç´  */
    function renderMarkdown(el, text, showCursor) {
      el.innerHTML = md.render(text);
      if (showCursor) {
        const cursor = document.createElement('span');
        cursor.className = 'streaming-cursor';
        el.appendChild(cursor);
      }
    }

    function showUsage(usage, model, cost) {
      const parts = [];
      if (model) parts.push(model);
      if (usage) {
        const prompt = usage.promptTokens ?? '?';
        const completion = usage.completionTokens ?? '?';
        parts.push(`tokens: ${prompt} â†’ ${completion}`);
      }
      if (cost) parts.push(cost);
      if (parts.length === 0) return;

      const el = document.createElement('div');
      el.className = 'usage';
      el.textContent = parts.join(' | ');
      messagesEl.appendChild(el);
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // â”€â”€ å‘é€ / åœæ­¢ â”€â”€
    function send() {
      const content = inputEl.value.trim();
      if (!content || isStreaming || !ws || ws.readyState !== 1) return;

      addMessage('user', content);

      const payload = { type: 'chat', content };
      if (sessionId) payload.sessionId = sessionId;
      ws.send(JSON.stringify(payload));

      inputEl.value = '';
      inputEl.style.height = 'auto';
      startStreaming();
    }

    function stopGeneration() {
      if (!isStreaming || !ws || ws.readyState !== 1) return;
      ws.send(JSON.stringify({ type: 'stop' }));
    }

    function startStreaming() {
      isStreaming = true;
      rawContent = '';
      currentBotMsg = null;
      sendBtn.disabled = true;
      stopBtn.classList.remove('inactive');
      inputEl.disabled = true;
      document.getElementById('input-area').classList.add('streaming');
    }

    function finishStreaming() {
      isStreaming = false;
      rawContent = '';
      currentBotMsg = null;
      sendBtn.disabled = false;
      stopBtn.classList.add('inactive');
      inputEl.disabled = false;
      inputEl.focus();
      document.getElementById('input-area').classList.remove('streaming');
    }

    // â”€â”€ å¤åˆ¶ä»£ç  â”€â”€
    function copyCode(btn) {
      const pre = btn.closest('.code-header').nextElementSibling;
      const code = pre?.querySelector('code')?.textContent || '';
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'å·²å¤åˆ¶';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'å¤åˆ¶';
          btn.classList.remove('copied');
        }, 2000);
      });
    }
    window.copyCode = copyCode;

    // â”€â”€ äº‹ä»¶ç»‘å®š â”€â”€
    sendBtn.addEventListener('click', send);
    stopBtn.addEventListener('click', stopGeneration);
    document.getElementById('sessions-btn').addEventListener('click', openSessionsSidebar);
    document.getElementById('sessions-close').addEventListener('click', closeSessionsSidebar);
    document.getElementById('sessions-new').addEventListener('click', newSession);
    document.getElementById('sessions-load-more').addEventListener('click', () => {
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'listConversations', offset: sessionsListOffset }));
    });

    // æ¶ˆæ¯åŒºæ»šåŠ¨åˆ°é¡¶æ—¶è‡ªåŠ¨åŠ è½½æ›´æ—©çš„æ¶ˆæ¯
    messagesEl.addEventListener('scroll', () => {
      if (hasMoreHistory && !loadingOlderHistory && messagesEl.scrollTop < 80) {
        loadOlderHistory();
      }
    });
    document.getElementById('sessions-overlay').addEventListener('click', closeSessionsSidebar);

    // Esc åœæ­¢ï¼šå…¨å±€ç›‘å¬ï¼Œä¸ä¾èµ– input ç„¦ç‚¹
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isStreaming) {
        e.preventDefault();
        stopGeneration();
      }
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
    });

    connect();
  </script>
</body>
</html>
